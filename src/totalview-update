#!/usr/bin/python
""" TODO doc """
import re
import os
import json
import copy
import time
import xml.etree.ElementTree as ET
import htcondor
import classad
from functions import parseArgs
from functions import getSchedds
from functions import getCollectors
from functions import getFromURL
from functions import rrdUpdate
from functions import createEmptyRRD
from functions import roundTime
from functions import querySchedd
from functions import queryCommandLineSchedd
from functions import validateInt
from timeout import TimeoutError

GSTARTUP = int(time.time())


def queryFactory(coll, output):
    """TODO: write it """
    try:
        entries = coll.query(htcondor.AdTypes.Any, 'MyType=?="glidefactory" && GLIDEIN_CMSSite isnt undefined && stringListIMember("CMS", GLIDEIN_Supported_VOs) =?= true',
                             ['GLIDEIN_CMSSite', 'GLIDEIN_MaxMemMBs', 'GLIDEIN_Max_Walltime', 'GLIDEIN_CPUS'])
    except IOError as er:
        print 'Failed to query factory. Error: %s' % er
        return
    for entry in entries:
        # So far it requires to -30minutes from Walltime request. TODO
        if 'GLIDEIN_MaxMemMBs' not in entry:
            entry['GLIDEIN_MaxMemMBs'] = 0
        if 'GLIDEIN_Max_Walltime' not in entry:
            entry['GLIDEIN_Max_Walltime'] = 0
            # Seems the hack is also needed for T0... so make it one week.
            if entry['GLIDEIN_CMSSite'] == 'T0_CH_CERN':
                entry['GLIDEIN_Max_Walltime'] = 600000
        if 'GLIDEIN_CPUS' not in entry:
            entry['GLIDEIN_CPUS'] = 1 # This is a hack, but seems HLT is not setting correct CPUS.
            # Due to HLT, lets make another hack, which I don`t like
            if entry['GLIDEIN_CMSSite'] == 'T2_CH_CERN_HLT':
                entry['GLIDEIN_CPUS'] = 8
        dataAppend = {'MaxMemMB': entry['GLIDEIN_MaxMemMBs'], 'MaxWallTime': int(entry['GLIDEIN_Max_Walltime']/60), 'MaxCpus': int(entry['GLIDEIN_CPUS'])}
        if entry['GLIDEIN_CMSSite'] not in output:
            output[entry['GLIDEIN_CMSSite']] = []
        inDict = False
        for item in output[entry['GLIDEIN_CMSSite']]:
            if cmp(item, dataAppend) == 0:
                inDict = True
        if not inDict:
            output[entry['GLIDEIN_CMSSite']].append(dataAppend)


def getcpucounts(scheddsInfo, scheddAds, warningsErrors):
    """ """
    for ad in scheddAds:
        print 'Getting CPU Counts from %s' % ad['Name']
        name = ad['Name'].replace("@", "-").replace(".", "-")
        if name not in scheddsInfo.keys():
            print 'WTF! Schedd is not there.... Schedd Ads: %s' % ad
            continue
        jobs = querySchedd(ad, "True", ['JobStatus', 'RequestCpus'])
        scheddsInfo[name].setdefault('TotalIdleCpus', 0)
        scheddsInfo[name].setdefault('TotalRunningCpus', 0)
        for job in jobs:
            requestCpus = 0 if 'RequestCpus' not in job.keys() else validateInt(job['RequestCpus'])
            if job['JobStatus'] == 1:
                scheddsInfo[name]['TotalIdleCpus'] += requestCpus
            elif job['JobStatus'] == 2:
                scheddsInfo[name]['TotalRunningCpus'] += requestCpus



def summarizeSchedds(scheddsInfo, scheddAds, warningsErrors):
    """ TODO: write it. """
    for ad in scheddAds:
        print ad
        # ['Name', 'CMSGWMS_Type', 'Machine', 'TotalRunningJobs', 'TotalIdleJobs', 'TotalHeldJobs', 'MaxJobsRunning']
        name = ad['Name'].replace("@", "-").replace(".", "-")
        scheddsInfo[name] = {"Summary": {"Unexpanded": 0, "Idle": 0, "Running": 0, "Removed": 0, "Completed": 0, "Held": 0, "Submission_err": 0, "Unknown": 0}}
        scheddsInfo[name]['FileName'] = name
        scheddsInfo[name]['CMSGWMS_Type'] = str(ad['CMSGWMS_Type']) if 'CMSGWMS_Type' in ad else 'CRAB2'
        if scheddsInfo[name]['CMSGWMS_Type'] == 'crabschedd':
            temp = str(ad['StartSchedulerUniverse']).split(" ")
            maxSchedulers = 0
            for item in temp:
                try:
                    maxSchedulers = int(item)
                    break
                except:
                    continue
            scheddsInfo[name]['MaxSchedulersRunning'] = maxSchedulers
            scheddsInfo[name]['TotalSchedulerJobsRunning'] = ad['TotalSchedulerJobsRunning'] if 'TotalSchedulerJobsRunning' in ad else 0
            scheddsInfo[name]['TotalSchedulerJobsIdle'] = ad['TotalSchedulerJobsIdle'] if 'TotalSchedulerJobsIdle' in ad else 0
            hackCRAB3SchedulerJobs(scheddsInfo, ad, name)
        keys = ['Name', 'Machine', 'TotalRunningJobs', 'TotalIdleJobs', 'TotalHeldJobs', 'MaxJobsRunning']
        for key in keys:
            scheddsInfo[name][key] = ad[key]
        try:
            scheddsInfo[name]['PercentageUse'] = 0 if ad['TotalRunningJobs'] == 0 else int((ad['TotalRunningJobs']*100)/ad['MaxJobsRunning'])
        except ZeroDivisionError:
            print 'No key', name, scheddsInfo[name], ad
            scheddsInfo[name]['PercentageUse'] = 0
        scheddStatus = "UNKNOWN"
        try:
            statusExpr = classad.ExprTree('ifThenElse(IsOK is undefined, "UNKNOWN", ifThenElse(IsOK,"OK", ifThenElse(IsCritical, "CRITICAL", "WARNING")))')
            scheddStatus = statusExpr.eval(ad)
        except:
            print 'Strange. wrong expression...', ad
            continue
        scheddsInfo[name]['Status'] = scheddStatus
        # Now if maxSchedulers is more than MaxSchedulersRunning, append message overloaded...
        if 'MaxSchedulersRunning' in scheddsInfo[name].keys():
            if 'Summary' in scheddsInfo[name].keys():
                if scheddsInfo[name]['MaxSchedulersRunning'] == scheddsInfo[name]['Summary']['Running'] and scheddsInfo[name]['Summary']['Idle'] > 0:
                    scheddsInfo[name]['Msg'] = "INFO: Scheduler running %s tasks and has %s tasks idle. Expect delays" % (scheddsInfo[name]['Summary']['Running'], scheddsInfo[name]['Summary']['Idle'])
    # Now lets add if there is any warning/critical message
    for item in warningsErrors:
        name = item[0].replace("@", "-").replace(".", "-")
        if len(item) == 3:
            if name not in scheddsInfo.keys():
                continue
            if 'Msg' not in scheddsInfo[name].keys():
                scheddsInfo[name]['Msg'] = ""
            else:
                scheddsInfo[name]['Msg'] += "<br>"
            if not item[2].startswith(' undefined'):
                scheddsInfo[name]['Msg'] += "CRITICAL: %s" % item[2]
            elif not item[1].startswith(' undefined'):
                scheddsInfo[name]['Msg'] += "WARNING: %s" % item[1]


def hackCRAB3SchedulerJobs(scheddsInfo, ad, name):
    """ Seems this ticket was not resolved... Lets make a hacky way """
    keys = ["JobStatus", "CRAB_UserHN"]
    jobs = querySchedd(ad, 'CRAB_ReqName isnt null && TaskType =?= "ROOT"', keys)
    scheddSummary = scheddsInfo.setdefault(name, {"Summary": {"Unexpanded": 0, "Idle": 0, "Running": 0, "Removed": 0, "Completed": 0, "Held": 0, "Submission_err": 0, "Unknown": 0}})
    userTopSummary = scheddsInfo.setdefault("UserSummary", {})
    MAPPING = {0: "Unexpanded", 1: "Idle", 2: "Running", 3: "Removed", 4: "Completed", 5: "Held", 6: "Submission_err"}
    userSummary = scheddSummary.setdefault("UserSummary", {})
    for job in jobs:
        userTopInfo = userTopSummary.setdefault(job['CRAB_UserHN'], {"Unexpanded": 0, "Idle": 0, "Running": 0, "Removed": 0, "Completed": 0, "Held": 0, "Submission_err": 0, "Unknown": 0})
        userInfo = userSummary.setdefault(job['CRAB_UserHN'], {"Unexpanded": 0, "Idle": 0, "Running": 0, "Removed": 0, "Completed": 0, "Held": 0, "Submission_err": 0, "Unknown": 0})
        if job['JobStatus'] not in MAPPING.keys():
            userInfo['Unknown'] += 1
            userTopInfo['Unknown'] += 1
            scheddSummary['Summary']['Unknown'] += 1
        else:
            userInfo[MAPPING[job['JobStatus']]] += 1
            userTopInfo[MAPPING[job['JobStatus']]] += 1
            scheddSummary['Summary'][MAPPING[job['JobStatus']]] += 1


def pilotUsageInfo(coll, pilotUsage, alreadyKnownPilot, factOut, ignoreT0=True):
    """ TODO """
    pilots = []
    hltHack = {}
    try:
        pilots = coll.query(htcondor.AdTypes.Any, 'GLIDEIN_CMSSite isnt undefined && SlotType isnt undefined',
                            ['Name', 'PartitionableSlot', 'GLIDEIN_CMSSite', 'TotalSlotCpus', 'Cpus', 'SlotType', 'State', 'Memory', 'TotalMemory', 'ChildMemory', 'ChildCpus', 'ChildAccountingGroup', 'AccountingGroup', 'GLIDEIN_ToRetire', 'GLIDEIN_ToDie', 'HAS_SINGULARITY', 'GLIDEIN_Max_Walltime', 'GLIDEIN_REQUIRED_OS'])
    except IOError as er:
        print 'Got IOError %s' % er
        return
    for item in pilots:
        if item['GLIDEIN_CMSSite'] == 'T0_CH_CERN' and ignoreT0:
            continue
        if 'PartitionableSlot' in item:
            singularity = item['HAS_SINGULARITY'] if 'HAS_SINGULARITY' in item else 'undefined'
            reqOS = item['GLIDEIN_REQUIRED_OS'] if 'GLIDEIN_REQUIRED_OS' in item else 'undefined'
            walltime = int(item['GLIDEIN_Max_Walltime']/60) if 'GLIDEIN_Max_Walltime' in item else 480
            tmpDict = {'MaxMemMB': item['TotalMemory'], 'MaxWallTime': walltime, 'MaxCpus': int(item['TotalSlotCpus']), 'SINGULARITY': str(singularity), 'OS': reqOS}
            inDict = False
            if item['GLIDEIN_CMSSite'] not in hltHack.keys():
                hltHack[item['GLIDEIN_CMSSite']] = []
            for inVal in hltHack[item['GLIDEIN_CMSSite']]:
                if cmp(tmpDict, inVal) == 0:
                    inDict = True
            if not inDict:
                hltHack[item['GLIDEIN_CMSSite']].append(tmpDict)
            # Means we have partitionable slot and some info about HLT and there is more info which is only in a pilot
            # and we don`t care about state as in Static
            slotInfo = pilotUsage.setdefault(item['GLIDEIN_CMSSite'], {}).setdefault(item['SlotType'], {'CpusUse': 0, 'CpusFree': 0})
            pilotStats = pilotUsage.setdefault(item['GLIDEIN_CMSSite'], {}).setdefault("PilotStatistics", {})
            if item['Name'] in pilotStats:
                #print 'Already here', item
                continue
            slotInfo['CpusFree'] += int(item['Cpus'])
            slotInfo['CpusUse'] += int(item['TotalSlotCpus'] - item['Cpus'])
            # Lets make some analysis and group requirements
            summaryInfo = slotInfo.setdefault('Utilization', {})
            # Round the time to nearest 10 mins value.
            # As we don`t want to end up with billion of values with 1 second resolution
            endTime = {}
            for timeKey in ['GLIDEIN_ToRetire', 'GLIDEIN_ToDie']:
                if timeKey not in item:
                    endTime[timeKey] = GSTARTUP
                else:
                    endTime[timeKey] = item[timeKey]
                endTime[timeKey] = roundTime(endTime[timeKey], 10*60)
            tempKey = '%s|%s|%s|%s|%s|%s' % (item['TotalSlotCpus'], item['Cpus'], item['TotalMemory'], item['Memory'], endTime['GLIDEIN_ToRetire'], endTime['GLIDEIN_ToDie'])
            tempsummaryInfo = summaryInfo.setdefault(tempKey, {'TotalSlotCpus': 0, 'Cpus': 0, 'TotalMemory': 0, 'Memory': 0, 'ChildMemory': [], 'ChildCpus': [], 'Counter' : 0, 'RetireTime': endTime['GLIDEIN_ToRetire'], 'DieTime': endTime['GLIDEIN_ToDie']})
            if tempsummaryInfo['TotalSlotCpus'] == 0 and tempsummaryInfo['TotalMemory'] == 0:
                for key in ['TotalSlotCpus', 'Cpus', 'TotalMemory', 'Memory']:
                    tempsummaryInfo[key] = item[key]
            tempsummaryInfo['Counter'] += 1
            for key in ['ChildMemory', 'ChildCpus']:
                tempVal = list(set(item[key]))
                if tempVal not in tempsummaryInfo[key]:
                    tempsummaryInfo[key].append(tempVal)
            # Pilot debug info...
            pilotStatsN = pilotStats.setdefault(item['Name'], {'TotalSlotCpus': item['TotalSlotCpus'],
                                                               'Cpus': item['Cpus'],
                                                               'TotalMemory': item['TotalMemory'],
                                                               'Memory': item['Memory'],
                                                               'ChildMemory': list(item['ChildMemory']),
                                                               'ChildCpus': list(item['ChildCpus']),
                                                               'ChildAccountingGroup': list(item['ChildAccountingGroup']),
                                                               'RetireTime': endTime['GLIDEIN_ToRetire'],
                                                               'DieTime': endTime['GLIDEIN_ToDie'],
                                                               'PilotType': 'Partitionable'})
        elif item['SlotType'] == 'Static':
            slotInfo = pilotUsage.setdefault(item['GLIDEIN_CMSSite'], {}).setdefault(item['SlotType'], {'CpusUse': 0, 'CpusFree': 0})
            pilotStats = pilotUsage.setdefault(item['GLIDEIN_CMSSite'], {}).setdefault("PilotStatistics", {})
            if item['Name'] in pilotStats:
                #print 'Already here', item
                continue
            singularity = item['HAS_SINGULARITY'] if 'HAS_SINGULARITY' in item else 'undefined'
            walltime = int(item['GLIDEIN_Max_Walltime']/60) if 'GLIDEIN_Max_Walltime' in item else 480
            reqOS = item['GLIDEIN_REQUIRED_OS'] if 'GLIDEIN_REQUIRED_OS' in item else 'undefined'
            tmpDict = {'MaxMemMB': item['Memory'], 'MaxWallTime': walltime, 'MaxCpus': int(item['TotalSlotCpus']), 'SINGULARITY': str(singularity), 'OS': reqOS}
            inDict = False
            if item['GLIDEIN_CMSSite'] not in hltHack.keys():
                hltHack[item['GLIDEIN_CMSSite']] = []
            for inVal in hltHack[item['GLIDEIN_CMSSite']]:
                if cmp(tmpDict, inVal) == 0:
                    inDict = True
            if not inDict:
                hltHack[item['GLIDEIN_CMSSite']].append(tmpDict)

            pilotStatsN = pilotStats.setdefault(item['Name'], {'TotalSlotCpus': item['TotalSlotCpus'],
                                                               'Cpus': item['Cpus'],
                                                               'TotalMemory': item['Memory'],
                                                               'Memory': item['Memory'],
                                                               'AccountingGroup': item['AccountingGroup'] if 'AccountingGroup' in item else 'None',
                                                               'RetireTime': item['GLIDEIN_ToRetire'],
                                                               'DieTime': item['GLIDEIN_ToDie'],
                                                               'PilotType': 'Static'})

            if item['State'] == 'Claimed':
                slotInfo['CpusUse'] += 1
            elif item['State'] == 'Unclaimed':
                slotInfo['CpusFree'] += 1

    for item, itemDict in pilotUsage.items():
        if item == 'Summary':
            continue
        for slot, slotDict in itemDict.items():
            if slot == 'PilotStatistics':
                continue
            out = pilotUsage.setdefault('Summary', {}).setdefault(slot, {'CpusUse': 0, 'CpusFree': 0})
            out['CpusUse'] += slotDict['CpusUse']
            out['CpusFree'] += slotDict['CpusFree']
    for siteName, values in hltHack.items():
        if siteName  not in factOut:
            factOut[siteName] = []
        for value in values:
            inDict = False
            for inVal in factOut[siteName]:
                if cmp(value, inVal) == 0:
                    inDict = True
                    break
            if not inDict:
                factOut[siteName].append(value)


def parseConfigXML(entries, output, factoryName, entryMappings, factoryentries, factOut):
    """ TODO doc """
    for entry in entries:
        entryName = entry.get('name')
        attr = entry.find('attributes')
        ettr = entry.find('descript')
        siteName = attr.get('GLIDEIN_CMSSite')
        mem = attr.get('GLIDEIN_MaxMemMBs', 0)
        walltime = attr.get('GLIDEIN_Max_Walltime', 0)
        cpus = attr.get('GLIDEIN_CPUS', 0)
        maxHeld = ettr.get('DefaultPerFrontendMaxHeld')
        maxIdle = ettr.get('DefaultPerFrontendMaxIdle')
        reqOS = attr.get('GLIDEIN_REQUIRED_OS')
        try:
            mem = int(mem)
        except ValueError:
            mem = mem
        try:
            walltime = int(int(walltime)/60)
        except ValueError:
            walltime = walltime
        try:
            cpus = int(cpus)
        except ValueError:
            cpus = cpus
        if siteName and entryName and maxHeld and maxIdle:
            for siteNew in [siteName, str(siteName + "_OSG")]:
                dataAppend = {'MaxMemMB': mem, 'MaxWallTime': walltime, 'MaxCpus': cpus, 'OS': reqOS}
                if siteNew not in factOut:
                    factOut[siteNew] = []
                inDict = False
                for item in factOut[siteNew]:
                    tmpitem = copy.deepcopy(item)
                    del tmpitem['SINGULARITY']
                    if cmp(tmpitem, dataAppend) == 0:
                        inDict = True
                        break
                if not inDict:
                    dataAppend['SINGULARITY'] = 'undefined'
                    factOut[siteNew].append(dataAppend)
            try:
                maxHeld = int(maxHeld)
                maxIdle = int(maxIdle)
            except:
                print 'Failed to parse value to int %s or %s' % (maxHeld, maxIdle)
                continue
            if entryName not in entryMappings:
                entryMappings[entryName] = siteName
            siteInfo = output.setdefault(siteName, {})
            entryInfo = siteInfo.setdefault(entryName, {})
            factoryInfo = entryInfo.setdefault(factoryName, {})
            factoryInfo['maxIdle'] = maxIdle
            factoryInfo['maxHeld'] = maxHeld
        else:
            dataAppend = {'MaxMemMB': mem, 'MaxWallTime': walltime, 'MaxCpus': cpus , 'OS': reqOS}
            siteNew = 'T4_OSG_' + entryName
            if siteNew not in factOut:
                factOut[siteNew] = []
            inDict = False
            for item in factOut[siteNew]:
                tmpitem = copy.deepcopy(item)
                del tmpitem['SINGULARITY']
                if cmp(tmpitem, dataAppend) == 0:
                    inDict = True
                    break
            if not inDict:
                dataAppend['SINGULARITY'] = 'undefined'
                factOut[siteNew].append(dataAppend)
        factsiteEntries = factoryentries.setdefault(entryName, {})
        if siteName:
            siteEntry = factsiteEntries.setdefault(siteName, {})


def appendtoOutput(output, siteName, entry, factory, held, idle, run, err=None, warning=None):
    """ TODO doc """
    if siteName:
        mapped = output.setdefault(siteName, {}).setdefault(entry, {}).setdefault(factory, {})
        mapped['nowHeld'] = int(float(held))
        mapped['nowIdle'] = int(float(idle))
        mapped['nowRunn'] = int(float(run))
        if err:
            errors = mapped.setdefault('Error', [])
            errors.append(err)
        if warning:
            warnings = mapped.setdefault('Warning', [])
            warnings.append(warning)


def parseRRDsData(entries, output, factoryName, entryMappings):
    """TODO doc """
    for entry in entries:
        entryName = entry.get('name')
        frontends = entry.find('frontends')
        foundCMSpilot = False
        foundPeriod = False
        previousEntry = None
        previousSiteName = None
        if len(frontends) == 0:
            foundCMSpilot = False
            if entryName in entryMappings:
                previousSiteName = entryMappings[entryName]
                previousEntry = entryName
            err = 'This entry does not have any pool defined. Check it with factory ops.'
            appendtoOutput(output, previousSiteName, previousEntry, factoryName, 0, 0, 0, err)
            continue
        for frontend in frontends:
            frontendName = frontend.get('name')
            if entryName in entryMappings:
                previousSiteName = entryMappings[entryName]
                previousEntry = entryName
            if frontendName not in ['frontend_CMSG-v1_0_cmspilot', 'frontend_CMS_T0-Frontend_cmspilot']:
                continue
            foundCMSpilot = True
            periods = frontend.find('periods')
            for period in periods:
                pname = period.get('name')
                if int(pname) != 7200:
                    continue
                foundPeriod = True
                nowHeld = period.get('StatusHeld')
                nowIdle = period.get('StatusIdle')
                nowRunn = period.get('StatusRunning')
                if not nowHeld and not nowIdle and not nowRunn:
                    warning = 'There is no data for last 2h about running/idle/held. Maybe no one is requesting?'
                    appendtoOutput(output, previousSiteName, previousEntry, factoryName, 0, 0, 0, None, warning)
                    continue
                appendtoOutput(output, previousSiteName, previousEntry, factoryName, nowHeld, nowIdle, nowRunn)
        if not foundPeriod and previousEntry and previousSiteName:
            error = 'There is no data for last 2h about running/idle/held. Maybe no one is requesting?'
            appendtoOutput(output, previousSiteName, previousEntry, factoryName, 0, 0, 0, error)
        if not foundCMSpilot and previousEntry and previousSiteName:
            error = 'This factory or frontend is not requesting pilots for this entry. Or entry is in downtime. Check it with factory ops.'
            appendtoOutput(output, previousSiteName, previousEntry, factoryName, 0, 0, 0, error)


def writeScheddInfo(basedir, scheddsInfo):
    """ TODO doc """
    now = int(time.time())
    scheddsInfo['Summary'] = {}
    scheddsInfo['Summary']['UpdateTime'] = now
    for scheddName, scheddDict in scheddsInfo.items():
        if scheddName in ['Negotiation', 'Collector']:
            continue
        if 'Name' not in scheddDict:
            continue
        requestDir = os.path.join(basedir, scheddName)
        fname = os.path.join(requestDir, "request.rrd")
        tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:Idle:GAUGE:360:U:U", "DS:RunningCpus:GAUGE:360:U:U", "DS:IdleCpus:GAUGE:360:U:U"]
        tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, scheddDict["TotalRunningJobs"], scheddDict["TotalIdleJobs"], scheddDict["TotalRunningCpus"], scheddDict["TotalIdleCpus"])
        # keys for warnings
        warningsKeys = ["DS:OK:GAUGE:360:U:U", "DS:WARNING:GAUGE:360:U:U", "DS:CRITICAL:GAUGE:360:U:U", "DS:UNKNOWN:GAUGE:360:U:U"]
        warnings = [0, 0, 0, 0]  # 0 - is ok, 1 - is warning, 2 - is critical
        if scheddDict['Status'] == "OK":
            warnings[0] += 1
        elif scheddDict['Status'] == "WARNING":
            warnings[1] += 1
        elif scheddDict['Status'] == "CRITICAL":
            warnings[2] += 1
        else:
            warnings[3] += 1
        tempUpdLine = str("%d:%d:%d:%d:%d" % (GSTARTUP, scheddDict["TotalRunningJobs"], scheddDict["TotalIdleJobs"],  scheddDict["TotalRunningCpus"], scheddDict["TotalIdleCpus"])) + ":" + str(":".join(["%d"]*len(warnings)) % tuple(warnings))
        if scheddDict['CMSGWMS_Type'] == 'crabschedd':
            tempKeys.append("DS:MaxDagmans:GAUGE:360:U:U")
            tempKeys.append("DS:RunningDagmans:GAUGE:360:U:U")
            tempKeys.append("DS:IdleDagmans:GAUGE:360:U:U")
            tempUpdLine = str("%d:%d:%d:%d:%d:%d:%d:%d" % (GSTARTUP, scheddDict["TotalRunningJobs"], scheddDict["TotalIdleJobs"], scheddDict["TotalRunningCpus"], scheddDict["TotalIdleCpus"],
                          scheddDict["MaxSchedulersRunning"], scheddDict['Summary']["Running"], scheddDict['Summary']["Idle"])) + ":" + \
                          str(":".join(["%d"]*len(warnings)) % tuple(warnings))
        tempKeys.extend(warningsKeys)
        rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

    #Diff between pools and Negotiation
    fname = os.path.join(basedir, 'difference.rrd')
    rrdUpdate(fname, ["DS:Current:GAUGE:360:U:U"], "%d:%d" % (GSTARTUP, scheddsInfo['Collector']['DIFF']), GSTARTUP)
    fname = os.path.join(basedir, 'negotiation.rrd')
    updateKeys = ["DS:NegotiationTime:GAUGE:360:U:U", "DS:NegotiationTimeT1:GAUGE:360:U:U", "DS:NegotiationTimeUS:GAUGE:360:U:U", "DS:Ideally:GAUGE:360:U:U"]
    updateLine = ""
    negMappings = {"NEGOTIATOR": ["vocms0815.cern.ch", "NEGOTIATOR"],
                   "NEGOTIATORT1": ["NEGOTIATORT1@vocms0815.cern.ch", "NEGOTIATORT1"],
                   "NEGOTIATORUS": ["NEGOTIATORUS@vocms0815.cern.ch", "NEGOTIATORUS"]}
    for key, negList in negMappings.items():
        # WTF!  Make a mapping so that easily changeble next time.
        alreadyFound = False
        for name in negList:
            print name, scheddsInfo['Negotiation']
            if name in scheddsInfo['Negotiation'].keys():
                #updateLine += ":%d" % 0
                updateLine += ":%d" % scheddsInfo['Negotiation'][name]
                alreadyFound = True
                scheddsInfo['Negotiation'][key] = scheddsInfo['Negotiation'][name]
                break
        if not alreadyFound:
            updateLine += ":%d" % 0
    print scheddsInfo['Negotiation']
    rrdUpdate(fname, updateKeys, "%d%s:%d" % (GSTARTUP, updateLine, 300), GSTARTUP)
    dropObj(scheddsInfo, basedir, 'summary.json')
    return


def loadPoolData(totals, sites, basedir, name):
    """TODO doc"""
    totals[name] = {}
    sites[name] = {}
    fname = os.path.join(basedir, 'totals.json')
    try:
        totalsSummary = json.load(open(fname))
        totals[name] = totalsSummary
    except:
        print 'Got Error loading file %s' % fname
    fname = os.path.join(basedir, 'site_summary.json')
    try:
        sitesSummary = json.load(open(fname))
        sites[name] = sitesSummary
    except:
        print 'Got Error loading file %s' % fname
        return False
    return True


def writeToVar(out, entryInfo):
    """ TODO doc """
    out['Summary']['Held'] += entryInfo['nowHeld']
    out['Summary']['Run'] += entryInfo['nowRunn']
    out['Summary']['Idle'] += entryInfo['nowIdle']
    out['Summary']['MIdle'] += entryInfo['maxIdle']
    out['Summary']['MHeld'] += entryInfo['maxHeld']
    out['Summary']['Errors'] += 0 if 'Error' not in entryInfo else len(entryInfo['Error'])
    out['Summary']['Warnings'] += 0 if 'Warning' not in entryInfo else len(entryInfo['Warning'])


def summarize(totals, sites, xmlout, sitesCompare, pilotUsage):
    """ TODO doc """
    totalR = 0
    totalI = 0
    totalCU = 0
    totalCP = 0
    for dummytype, typeDict in totals.items():
        if 'Running' in typeDict.keys():
            totalR += typeDict['Running']
        if 'Idle' in typeDict.keys():
            totalI += typeDict['Idle']
        if 'CpusInUse' in typeDict.keys():
            totalCU += typeDict['CpusInUse']
        if 'CpusPending' in typeDict.keys():
            totalCP += typeDict['CpusPending']
    totals['Summary'] = {}
    totals['Summary']['Running'] = totalR
    totals['Summary']['Idle'] = totalI
    totals['Summary']['CpusInUse'] = totalCU
    totals['Summary']['CpusPending'] = totalCP

    sites['Summary'] = {}
    for typeK, typeDict in sites.items():
        if not typeK == 'Summary':
            for site, siteDict in typeDict.items():
                if site and site != "Summary":
                    if site not in sites['Summary'].keys():
                        sites['Summary'][site] = {"Running": 0, "MatchingIdle": 0, "UniquePressure": 0, "CpusInUse": 0, "CpusPending": 0}
                    sites['Summary'][site]['Running'] += siteDict['Running']
                    sites['Summary'][site]['MatchingIdle'] += siteDict['MatchingIdle']
                    sites['Summary'][site]["UniquePressure"] += siteDict["UniquePressure"]
                    sites['Summary'][site]['CpusInUse'] += siteDict['CpusInUse']
                    sites['Summary'][site]['CpusPending'] += siteDict['CpusPending']
                    sites['Summary'][site][typeK] = siteDict
                    if site in pilotUsage:
                        sites['Summary'][site]['PilotUsage'] = pilotUsage[site]

    # Double check with what maximum was
    for site, siteDict in sites['Summary'].items():
        for item in [['MaxWasRunning', 'Running'], ['MaxWasCpusUse', 'CpusInUse']]:
            if site in sitesCompare and item[0] in sitesCompare[site]:
                if siteDict[item[1]] > sitesCompare[site][item[0]]:
                    sites['Summary'][site][item[0]] = siteDict[item[1]]
                else:
                    sites['Summary'][site][item[0]] = sitesCompare[site][item[0]]
            else:
                sites['Summary'][site][item[0]] = siteDict[item[1]]

    xmlout['Summary'] = {'Held': 0, 'Idle': 0, 'Run': 0, 'MHeld': 0, 'MIdle': 0, 'Errors': 0, 'Warnings': 0}
    for siteName, entriesDict in xmlout.items():
        if siteName not in ['Summary', 'Errors']:
            entriesDict["Summary"] = {'Held': 0, 'Idle': 0, 'Run': 0, 'MHeld': 0, 'MIdle': 0, 'Errors': 0, 'Warnings': 0}
            for entry, factoryDict in entriesDict.items():
                if entry in ['Summary']:
                    continue
                for dummyfactory, entryInfo in factoryDict.items():
                    # fix the mess in the factory!!!
                    # Until factory will move all their xmls to somewhere where you can track history
                    # who did changes than, we need to track this down.
                    # The problem is that same entry name points to different cms sites on diff factories
                    # And one entry is on, another is off. Who forgot to update ?!
                    messedUp = False
                    for key in ['nowHeld', 'nowRunn', 'nowIdle', 'maxIdle', 'maxHeld']:
                        if key not in entryInfo:
                            entryInfo[key] = 0
                            messedUp = True
                    if messedUp:
                        errors = entryInfo.setdefault('Error', [])
                        errors.append("Messed up! Please contact factory ops.")
                    elif entryInfo['nowHeld'] > 0 and entryInfo['nowHeld'] >= entryInfo['maxHeld']:
                        # Everything is held and there will not be any progress until it is cleaned
                        errors = entryInfo.setdefault('Error', [])
                        errors.append("Held pilots reached limit. Factory/Frontend will not request any new pilot to run until they are cleaned. \
                                      Contact Factory ops to know the held reason.")
                    elif entryInfo['nowIdle'] > 0 and entryInfo['nowIdle'] >= entryInfo['maxIdle'] and entryInfo['nowRunn'] == 0:
                        warnings = entryInfo.setdefault('Warning', [])
                        warnings.append("Idle pilots reached its limit and there is 0 running. Something is wrong.")
                    writeToVar(xmlout, entryInfo)
                    writeToVar(entriesDict, entryInfo)


def dropObj(obj, dirname, fname):
    """ TODO move from here """
    dirname = re.sub('[:]', '', dirname)
    fname = re.sub('[:]', '', fname)
    if not os.path.exists(dirname):
        os.makedirs(dirname)
    fnameTmp = os.path.join(dirname, fname + ".tmp")
    fname = os.path.join(dirname, fname)
    json.dump(obj, open(fnameTmp, "w"))
    os.rename(fnameTmp, fname)


def writeJson(totals, sites, xmlout, output, factoryout):
    """TODO: write doc"""
    now = int(time.time())
    totals['Summary']['UpdateTime'] = now
    dropObj(totals['Summary'], output, 'summary.json')
    dropObj(totals, output, 'totals.json')
    sitesT = sites.setdefault('Summary', {})
    dropObj(sitesT, output, 'site_summary.json')
    for site, siteDict in sitesT.items():
        siteDir = os.path.join(output, site)
        dropObj(siteDict, siteDir, "summary.json")
    dropObj(xmlout['Summary'], factoryout, 'summary.json')
    for site, siteDict in xmlout.items():
        if site in ['Errors', 'Summary']:
            continue
        siteDir = os.path.join(factoryout, site)
        dropObj(siteDict, siteDir, 'summary.json')
    dropObj(xmlout, factoryout, 'totals.json')


def writeRrds(totals, sites, xmlout, output, factoryout):
    """ TODO doc """
    createEmptyRRD(output, GSTARTUP)
    running = totals['Summary']['Running']
    idle = totals['Summary']['Idle']
    cpususe = totals['Summary']['CpusInUse']
    cpuspen = totals['Summary']['CpusPending']
    fname = str(os.path.join(output, "summary.rrd"))
    tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:Idle:GAUGE:360:U:U", "DS:CpusUse:GAUGE:360:U:U", "DS:CpusPen:GAUGE:360:U:U"]
    tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, running, idle, cpususe, cpuspen)
    rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

    counters = {"T0": [0, 0, 0, 0], "T1": [0, 0, 0, 0], "T2": [0, 0, 0, 0], "T3": [0, 0, 0, 0]}
    for site, siteDict in sites['Summary'].items():
        # Make global statistics about fairshare
        updateLine = [0, 0, 0, 0]
        for groupKey in counters.keys():
            if site.startswith(groupKey):
                for key in [['prodview', 0, 1], ['analysisview', 2, 3]]:
                    if key[0] in sites.keys() and site in sites[key[0]].keys():
                        counters[groupKey][key[1]] += sites[key[0]][site]['CpusInUse']
                        counters[groupKey][key[2]] += sites[key[0]][site]['Running']
                        updateLine[key[1]] = sites[key[0]][site]['CpusInUse']
                        updateLine[key[2]] = sites[key[0]][site]['Running']
                    else:
                        updateLine[key[1]] = 0
                        updateLine[key[2]] = 0
                        #
        # Now it is separate rrd, it is not yet a problem, but in any case, all below 3 could be joined into 1 in case there is a IOPS issues
        fname = str(os.path.join(output, "%s-FAIRSHARE.rrd" % site))
        tempKeys = ["DS:CpusInUseProd:GAUGE:360:U:U", "DS:RunningProd:GAUGE:360:U:U", "DS:CpusInUseAna:GAUGE:360:U:U", "DS:RunningAna:GAUGE:360:U:U"]
        tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, updateLine[0], updateLine[1], updateLine[2], updateLine[3])
        rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

        fname = str(os.path.join(output, "%s.rrd" % site))
        tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:MatchingIdle:GAUGE:360:U:U", "DS:CpusUse:GAUGE:360:U:U", "DS:CpusPen:GAUGE:360:U:U"]
        tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, siteDict["Running"], siteDict["MatchingIdle"], siteDict["CpusInUse"], siteDict["CpusPending"])
        rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

        fname = str(os.path.join(output, "%s-UTIL.rrd" % site))
        tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:MaxRunning:GAUGE:360:U:U", "DS:CpusUse:GAUGE:360:U:U", "DS:MaxCpusUse:GAUGE:360:U:U"]
        tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, siteDict["Running"], siteDict["MaxWasRunning"], siteDict["CpusInUse"], siteDict["MaxWasCpusUse"])
        rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

        if 'PilotUsage' in siteDict:
            partR = 0 if 'Partitionable' not in siteDict['PilotUsage'] else siteDict['PilotUsage']['Partitionable']['CpusUse']
            partI = 0 if 'Partitionable' not in siteDict['PilotUsage'] else siteDict['PilotUsage']['Partitionable']['CpusFree']
            statR = 0 if 'Static' not in siteDict['PilotUsage'] else siteDict['PilotUsage']['Static']['CpusUse']
            statI = 0 if 'Static' not in siteDict['PilotUsage'] else siteDict['PilotUsage']['Static']['CpusFree']
            fname = str(os.path.join(output, "%s-USAGE.rrd" % site))
            tempKeys = ["DS:PartRunning:GAUGE:360:U:U", "DS:PartIdle:GAUGE:360:U:U", "DS:StatRunning:GAUGE:360:U:U", "DS:StatIdle:GAUGE:360:U:U"]
            tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, partR, partI, statR, statI)
            rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)
    countSumAll = [0, 0, 0, 0]
    for key, vals in counters.items():
        countSumAll = [countSumAll[i] + vals[i] for i in xrange(len(vals))]
        print key, vals
        fname = str(os.path.join(output, "%s-FAIRSHARE.rrd" % key))
        tempKeys = ["DS:CpusInUseProd:GAUGE:360:U:U", "DS:RunningProd:GAUGE:360:U:U", "DS:CpusInUseAna:GAUGE:360:U:U", "DS:RunningAna:GAUGE:360:U:U"]
        tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, vals[0], vals[1], vals[2], vals[3])
        rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)
    # Sum
    counters['ALL'] = countSumAll
    dropObj(counters, output, 'fairshare.json')
    fname = str(os.path.join(output, "TALL-FAIRSHARE.rrd"))
    tempKeys = ["DS:CpusInUseProd:GAUGE:360:U:U", "DS:RunningProd:GAUGE:360:U:U", "DS:CpusInUseAna:GAUGE:360:U:U", "DS:RunningAna:GAUGE:360:U:U"]
    tempUpdLine = "%d:%d:%d:%d:%d" % (GSTARTUP, countSumAll[0], countSumAll[1], countSumAll[2], countSumAll[3])
    rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

    fname = str(os.path.join(factoryout, 'summary.rrd'))
    summary = xmlout['Summary']
    tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:Idle:GAUGE:360:U:U", "DS:Held:GAUGE:360:U:U", "DS:MaxIdle:GAUGE:360:U:U", "DS:MaxHeld:GAUGE:360:U:U"]
    tempUpdLine = "%d:%d:%d:%d:%d:%d" % (GSTARTUP, summary['Run'], summary['Idle'], summary['Held'], summary['MIdle'], summary['MHeld'])
    rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

    for site, siteDict in xmlout.items():
        if site in ['FactoryUrls', 'Errors', 'Summary']:
            continue
        for entry, entryDict in siteDict.items():
            if entry == 'Summary':
                fname = str(os.path.join(factoryout, '%s.rrd' % site))
                tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:Idle:GAUGE:360:U:U", "DS:Held:GAUGE:360:U:U",
                            "DS:MaxIdle:GAUGE:360:U:U", "DS:MaxHeld:GAUGE:360:U:U"]
                tempUpdLine = "%d:%d:%d:%d:%d:%d" % (GSTARTUP, entryDict['Run'], entryDict['Idle'],
                                                     entryDict['Held'], entryDict['MIdle'], entryDict['MHeld'])
                rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)
                continue
            else:
                subsiteDir = os.path.join(factoryout, site)
                if not os.path.exists(subsiteDir):
                    os.makedirs(subsiteDir)
                for factory, factoryInfo in entryDict.items():
                    newName = str(re.sub('[ ]', '', factory.lower()) + (re.sub('[ ]', '', entry)))
                    fname = os.path.join(subsiteDir, '%s.rrd' % newName)
                    tempKeys = ["DS:Running:GAUGE:360:U:U", "DS:Idle:GAUGE:360:U:U", "DS:Held:GAUGE:360:U:U",
                                "DS:MaxIdle:GAUGE:360:U:U", "DS:MaxHeld:GAUGE:360:U:U"]
                    tempUpdLine = "%d:%d:%d:%d:%d:%d" % (GSTARTUP, factoryInfo['nowRunn'], factoryInfo['nowIdle'],
                                                         factoryInfo['nowHeld'], factoryInfo['maxIdle'], factoryInfo['maxHeld'])
                    rrdUpdate(fname, tempKeys, tempUpdLine, GSTARTUP)

def queryWithRetries(pool, queryType, const, values, retries=2):
    retried = 0
    while retried < retries:
        entries = []
        coll = htcondor.Collector(pool)
        try:
            entries = coll.query(queryType, const, values)
        except IOError:
            pass
        if len(entries) > 0:
            return entries
        else:
            retried += 1
    return []

def poolDiffNeg(scheddsInfo, opts):
    scheddsInfo['Collector'] = {}
    scheddsInfo['Negotiation'] = {}
    for item in [opts.pool, opts.pool1]:
        entries = queryWithRetries(item.split(":")[0], htcondor.AdTypes.Any, 'State=?="Claimed"', ['Name'])
        scheddsInfo['Collector'][item] = len(entries)
    # See the diff
    scheddsInfo['Collector']['DIFF'] = (scheddsInfo['Collector'][opts.pool] - scheddsInfo['Collector'][opts.pool1])
    scheddsInfo['Collector']['INFO'] = "Difference between collector total job counts: %s (%s) - %s (%s) = %s" % (scheddsInfo['Collector'][opts.pool], opts.pool, scheddsInfo['Collector'][opts.pool1], opts.pool1, scheddsInfo['Collector']['DIFF'])
    # Negotiation time
    for item in [opts.pool, opts.pool1]:
        entries = queryWithRetries(item.split(":")[0], htcondor.AdTypes.Negotiator, 'True', ['Name', 'LastNegotiationCycleDuration0'])
        print entries
        for ad in entries:
            if 'LastNegotiationCycleDuration0' in ad:
                scheddsInfo['Negotiation'][ad['Name']] =  ad['LastNegotiationCycleDuration0']

def main():
    """ Main function """
    opts, dummyargs = parseArgs()

    # Has to be moved below
    factOut = {}  # Used from condor
    xmlOut = {}  # Used from parsing xmls
    entryMappings = {}  # Used for entries mapping from factory xmls
    # Move this list to configuration
    #for factory in ['gfactory-1.t2.ucsd.edu', 'cmsgwms-factory.fnal.gov', 'glidein.grid.iu.edu', 'vocms0805.cern.ch']:
    #    print 'Query %s factory' % factory
    #    collF = htcondor.Collector(factory)
    #    queryFactory(collF, factOut)
    # Get schedulers information
    scheddsInfo = {}

    succeed = True
    while succeed:
        print time.time()
        try:
            scheddAds, coll = getSchedds(opts, opts.pool, 'True', ['Name', 'CMSGWMS_Type', 'Machine', 'TotalRunningJobs', 'TotalIdleJobs',
                                                               'TotalHeldJobs', 'MaxJobsRunning', 'IsOK', 'isWarning', 'isCritical',
                                                               'TotalSchedulerJobsRunning', 'TotalSchedulerJobsIdle', 'StartSchedulerUniverse',
                                                               'MyAddress', 'ScheddIpAddr'], split = True)
            succeed = False
        except TimeoutError as er:
            print time.time()
            print er


    warningErrors = queryCommandLineSchedd(opts.pool.split(":")[0], "Name isWarningReason isCriticalReason")
    if scheddAds:
        summarizeSchedds(scheddsInfo, scheddAds, warningErrors)
        getcpucounts(scheddsInfo, scheddAds, warningErrors)
    poolDiffNeg(scheddsInfo, opts)
    writeScheddInfo(opts.poolview, scheddsInfo)

    pilotUsage = {}
    totals = {}
    sites = {}

    coll1, coll2 = getCollectors(opts.pool, opts.pool1, main=True)
    alreadyKnownPilot = []
    print '%s querying %s ' % (int(time.time()), opts.pool)
    pilotUsageInfo(coll1, pilotUsage, alreadyKnownPilot, factOut)
    print '%s querying %s' % (int(time.time()), opts.pool1)
    pilotUsageInfo(coll2, pilotUsage, alreadyKnownPilot, factOut)
    print '%s done querying' % int(time.time())
    print '%s querying %s' % (int(time.time()), 'T0 POOL')
    tmpColl1, tmpColl2 = getCollectors("cmsgwms-collector-tier0.cern.ch:9618", opts.pool1, main=True)
    pilotUsageInfo(tmpColl1, pilotUsage, alreadyKnownPilot, factOut, False)
    print '%s done querying' % int(time.time())
    loadPoolData(totals, sites, opts.analysisview, "analysisview")
    loadPoolData(totals, sites, opts.prodview, "prodview")
    loadPoolData(totals, sites, opts.cmsconnectview, "cmsconnectview")
    loadPoolData(totals, sites, opts.institutionalview, "institutionalview")
    maxResources = {}
    maxTotals = {}
    i = 0
    while i < 5:
        success = loadPoolData(maxTotals, maxResources, opts.totalview, "totalview")
        if success:
            break
        print 'Failed to load site data for resource utilization'
        time.sleep(1)
        i += 1
    # Move this list to configuration also
    urls = [{"FNAL Factory": "http://cmsgwms-factory.fnal.gov:8319/factory/monitor/"},
            {"GOC Factory": "http://glidein.grid.iu.edu/factory/monitor/"},
            {"UCSD Factory": "http://gfactory-1.t2.ucsd.edu/factory/monitor/"},
            {"CERN Factory": "http://vocms0805.cern.ch/monitor/"}]
    appends = ['descript.xml', 'rrd_Status_Attributes.xml']
    errors = xmlOut.setdefault("Errors", [])
    factentries = {}
    for appendId in [0, 1]:
        for urlVal in urls:
            print urlVal, appends[appendId]
            print int(time.time())
            factoryName, url = urlVal.items()[0]
            urlD = url + appends[appendId]
            try:
                factoryXml = getFromURL(urlD)
            except TimeoutError as er:
                errors.append("Reached timeout receiving info from %s url" % (urlD))
                print errors
                continue

            if not factoryXml:
                errors.append("Failed to parse %s info from %s url" % (factoryName, urlD))
                continue
            try:
                root = ET.fromstring(factoryXml)
            except:
                errors.append("Failed to parse %s info from %s xml" % (factoryName, urlD))
                continue
            entries = root.find('entries')
            if appendId == 0:
                parseConfigXML(entries, xmlOut, factoryName, entryMappings, factentries, factOut)
            else:
                parseRRDsData(entries, xmlOut, factoryName, entryMappings)
            print int(time.time())
    #print pilotUsage
    dropObj(factOut, opts.poolview, 'totals.json')
    dropObj(factentries, opts.factoryview, 'fact_entries.json')
    summarize(totals, sites, xmlOut, maxResources['totalview'], pilotUsage)
    xmlOut["Summary"]["FactoryUrls"] = {}
    for urlVal in urls:
        factoryName, url = urlVal.items()[0]
        xmlOut["Summary"]["FactoryUrls"][factoryName] = url
    if opts.totalview:
        writeJson(totals, sites, xmlOut, opts.totalview, opts.factoryview)
        writeRrds(totals, sites, xmlOut, opts.totalview, opts.factoryview)

if __name__ == "__main__":
    main()

